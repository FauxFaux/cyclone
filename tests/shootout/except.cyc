/*
 * http://www.bagley.org/~doug/shootout/
 */

#include <stdio.h>
#include <stdlib.h>
#include "timer.h"

int HI = 0, LO = 0;

datatype @extensible exn { Hi_exception(int); };
datatype @extensible exn { Lo_exception(int); };

void blowup (int n) {
    if (n & 1) {
        throw new Lo_exception(1);
    } else {
	throw new Hi_exception(1);
    }
}

void lo_function (volatile int n) {
    try blowup(n);
    catch {
    case &Lo_exception(_): LO++; break;
    }
}

void hi_function (volatile int n) {
    try lo_function(n);
    catch {
    case &Hi_exception(_): HI++; break;
    }
}

void some_function (int n) {
    hi_function(n);
}

int
main(int argc, char ??argv) {
    int volatile N = ((argc == 2) ? atoi(argv[1]) : 1);
    START_TIME
    while (N) {
	some_function(N--);
    }
    printf("Exceptions: HI=%d / LO=%d\n", HI, LO);
    END_TIME
    return(0);
}
