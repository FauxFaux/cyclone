/* -*- mode: c -*-
 * spellcheck.gcc
 * http://www.bagley.org/~doug/shootout/
 */

#include <ctype.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include "simple_hash_cyc.h"

#define MAXLINELEN 128

int main(int argc, char ?argv[]) {
    int i, wordbufsize = 80;
    char line[MAXLINELEN];
    char c, ?cp, ?wordbuf = new {for i < wordbufsize + 1 : '\000'};
    struct ht_ht *dict = ht_create(40000);
    FILE *fh;
    
    if ((fh = fopen("words.txt", "r")) == NULL) {
	perror("fopen");
	exit(1);
    }
    i = 0;
    while (fgets(line, MAXLINELEN, fh)) {
	for (cp=line; *cp > 0; cp++) {
	    if (isspace(*cp)) {
		if (i > 0) {
		    wordbuf[i] = '\0';
		    ht_find_new(dict, wordbuf)->val = 1;
		    i = 0;
		}
	    } else {
		wordbuf[i++] = *cp;
		if (i == wordbufsize) {
  		    let old_wordbufsize = wordbuf.size;
		    wordbufsize *= 2;
		    wordbuf = new {for i < wordbufsize + 1 : 
				   (i < old_wordbufsize) ? 
				   wordbuf[i] : '\000'};
		    //wordbuf = realloc(wordbuf, wordbufsize + 1);
		}
	    }
        }
    }
    fclose(fh);

    i = 0;
    while (fgets(line, MAXLINELEN, stdin)) {
	for (cp=line; *cp > 0; cp++) {
	    if (isspace(*cp)) {
		if (i > 0) {
		    wordbuf[i] = '\0';
		    if (ht_find(dict, wordbuf) == NULL) {
			printf("%s\n", wordbuf);
		    }
		    i = 0;
		}
	    } else {
		wordbuf[i++] = *cp;
		if (i == wordbufsize) {
  		    let old_wordbufsize = wordbuf.size;
		    wordbufsize *= 2;
		    wordbuf = new {for i < wordbufsize + 1 : 
				   (i < old_wordbufsize) ? 
				   wordbuf[i] : '\000'};
		    //wordbuf = realloc(wordbuf, wordbufsize + 1);
		}
	    } 
        }
    }
    //free(wordbuf);
    ht_destroy(dict);
    return(0);
}
