\section{Frequently Asked Questions}

% Environment for frequently asked question and answer
%HEVEA \begin{latexonly}
\ifscreen
\newenvironment{faqa}[2]{%
  \begin{list}{}{}%
  \item[\hypertarget{#1}{\colorbox{lightblue}{\textbf{#2}}}]}{\end{list}}
\else
\newenvironment{faqa}[2]{%
  \begin{list}{}{}%
  \item[\hypertarget{#1}{\textbf{#2}}]}{\end{list}}
\fi
%HEVEA \end{latexonly}
%HEVEA \newenvironment{faqa}[2]{%
%HEVEA   \begin{list}{}{}%
%HEVEA   \item[\hypertarget{#1}{%
%HEVEA \begin{rawhtml}<table><tr><td bgcolor="c0d0ff">\end{rawhtml}%
%HEVEA \textbf{#2}%
%HEVEA \begin{rawhtml}</td></tr></table>\end{rawhtml}%
%HEVEA }]}{\end{list}}

\ifscreen
\begin{small}
\hyperlink{faq:tuple}{What does \texttt{\$({\it type}$_1$,{\it type}$_2$)} mean?  What does \texttt{\$({\it expr}$_1$, {\it expr}$_2$)} mean?}\\
\hyperlink{faq:non-null}{What does \texttt{int @} mean?}\\
\hyperlink{faq:bounds}{What does \texttt{int *\lb 37\rb} mean?}\\
\hyperlink{faq:region}{What does \texttt{int *`r} mean?}\\
\hyperlink{faq:heapregion}{What does \texttt{`H} mean?}\\
\hyperlink{faq:boundsregion}{What does \texttt{int @\lb 37\rb `r} mean?}\\
\hyperlink{faq:questionable}{What does \texttt{int ?} mean?}\\
\hyperlink{faq:omitregion}{What is a pointer type's region when it's omitted?}\\
\hyperlink{faq:typevar}{What does \texttt{`a} mean?}\\
\hyperlink{faq:suitable}{What is a ``suitable'' type for a type variable?}\\
\hyperlink{faq:voidstar}{How do I cast from \texttt{void *}?}\\
\hyperlink{faq:uscore-types}{What does \texttt{_} (underscore) mean in types?}\\
%\hyperlink{faq:uscore-region}{In particular, what does \texttt{int *_} mean?}\\
\hyperlink{faq:kinds}{What do \texttt{`a::B}, \texttt{`a::M}, \texttt{`a::A}, \texttt{`a::R}, and \texttt{`a::E} mean?}\\
\hyperlink{faq:nokinds}{What does it mean when type variables don't have explicit kinds?}\\
\hyperlink{faq:list}{What does \texttt{struct List<`a,`r::R>} mean?}\\
\hyperlink{faq:tagged}{What are \texttt{tunion} and \texttt{xtunion}?}\\
\hyperlink{faq:abstract}{What is \texttt{abstract}?}\\
\hyperlink{faq:keywords}{What are the Cyclone keywords?}\\
\hyperlink{faq:namespace}{What are \texttt{namespace} and \texttt{using}?}\\
\hyperlink{faq:fallthru}{What is \texttt{fallthru}?}\\
\hyperlink{faq:new}{What is \texttt{new}?}\\
\hyperlink{faq:usetuples}{How do I use tuples?}\\
\hyperlink{faq:arrayinit}{What is \texttt{\lb for i < {\it expr}$_1$ : {\it expr}$_2$\rb}?}\\
\hyperlink{faq:exns}{How do I throw and catch exceptions?}\\
\hyperlink{faq:exn-efficiency}{How efficient is exception handling?}\\
\hyperlink{faq:let}{What does \texttt{let} mean?}\\
\hyperlink{faq:pattern}{What is a pattern and how do I use it?}\\
\hyperlink{faq:uscore-pattern}{What does \texttt{_} mean in a pattern?}\\
\hyperlink{faq:polymorphic}{What does it mean when a function has an argument with type \texttt{`a}?}\\
\hyperlink{faq:templates}{Do functions with type variables get duplicated like C++ template functions?\\  Is there run-time overhead for using type variables?}\\
\hyperlink{faq:vararg}{Can I use varargs?}\\
\hyperlink{faq:typesinfunctions}{Why can't I declare types within functions?}\\
\hyperlink{faq:casts}{What casts are allowed?}\\
\hyperlink{faq:implicitfallthru}{Why can't I implicitly fall-through to the next \texttt{switch} case?}\\
\hyperlink{faq:globalinit}{Do I have to initialize global variables?}\\
\hyperlink{faq:threads}{Are there threads?}\\
\hyperlink{faq:setjmp}{Can I use \texttt{setjmp} and \texttt{longjmp}?}\\
\hyperlink{faq:uniontypes}{What types are allowed for union members?}\\
\hyperlink{faq:voidstar2}{Why can't I do anything with values of type \texttt{void *}?}\\
\hyperlink{faq:aprintf}{What is \texttt{aprintf}?}\\
\hyperlink{faq:commandline}{How do I access command-line arguments?}\\
\hyperlink{faq:stackpointer}{Why can't I pass a stack pointer to certain functions?}\\
\hyperlink{faq:localaddress}{Why do I get an incomprehensible error when I assign a local's address to a pointer variable?}\\
\hyperlink{faq:pointerarith}{How much pointer arithmetic can I do?}\\
\hyperlink{faq:litstring}{What is the type of a literal string?}\\
\hyperlink{faq:nullterminate}{Are strings null-terminated?}\\
\hyperlink{faq:malloc}{How do I use \texttt{malloc}?}\\
\hyperlink{faq:free}{Can I call free?}\\
\hyperlink{faq:gc}{Is there a garbage collector?}\\
\hyperlink{faq:stackalloc}{How can I make a stack-allocated array?}\\
\hyperlink{faq:realloc}{Can I use \texttt{salloc} or \texttt{realloc}?}\\
\hyperlink{faq:nullcast}{Why do I have to cast from \texttt{*} to \texttt{@} if I've already tested for \texttt{NULL}?}\\
\hyperlink{faq:memkind}{Why can't a function parameter or struct field have type \texttt{`a::M}?}\\
\hyperlink{faq:compile}{Can I see how Cyclone compiles the code?}\\
\hyperlink{faq:gdb}{Can I use \texttt{gdb} on the output?}\\
\hyperlink{faq:gprof}{Can I use \texttt{gprof} on the output?}\\
\hyperlink{faq:emacs}{Is there an Emacs mode for Cyclone?}\\
\hyperlink{faq:rtcg}{Does Cyclone have something to do with runtime code generation?}\\
\hyperlink{faq:platforms}{What platforms are supported?}\\
\hyperlink{faq:libs}{Why aren't there more libraries?}\\
\hyperlink{faq:imprev}{Why doesn't \texttt{List::imp_rev(l)} change \texttt{l} to its reverse?}\\
\hyperlink{faq:inline}{Can I inline functions?}\\
\hyperlink{faq:crash}{If Cyclone is safe, why does my program crash?}\\
\hyperlink{faq:ctc}{What are compile-time constants?}\\
\hyperlink{faq:arraysize}{How can I get the size of an array?}
\end{small}
\fi

\begin{faqa}{faq:tuple}{What does \texttt{\$({\it type}$_1$,{\it type}$_2$)} mean?  What does \texttt{\$({\it expr}$_1$, {\it expr}$_2$)} mean?}

Cyclone has \emph{tuples}, which are anonymous structs with fields
numbered 0, 1, 2, \ldots.  For example, \texttt{\$(int,string_t)} is a
pair of an \texttt{int} and a \texttt{string_t}.  An example value of
this type is \texttt{\$(4,"cyclone")}.  To extract a field from a
tuple, you use array-like notation: you write \texttt{x[0]}, not
\texttt{x.0}.
\end{faqa}

\begin{faqa}{faq:non-null}{What does \texttt{int @} mean?}
In Cyclone \texttt{@} is a pointer that is guaranteed not to be
\texttt{NULL}.  The Cyclone compiler guarantees through static or
dynamic checks.  For example,
\begin{verbatim}
  int *x = NULL;
\end{verbatim}
is not an error, but
\begin{verbatim}
  int @x = NULL;
\end{verbatim}
is an error
\end{faqa}

\begin{faqa}{faq:bounds}{What does \texttt{int *\lb 37\rb} mean?}
This is the type of pointers to a sequence of at least 37 integers.
The extra length information is used by Cyclone to prevent buffer
overflows.  For example, Cyclone will compile
\texttt{x[\textup{\textit{expr}}]} into code that will evaluate
\textit{expr}, and check that the result is less than 37 before
accessing the element.  Note that \texttt{int *} is just shorthand for
\verb|int *{1}|.  Currently, the expression in the braces must be a
compile-time constant.
\end{faqa}

\begin{faqa}{faq:region}{What does \texttt{int *`r} mean?}
This is the type of a pointer to an \texttt{int} in region
\texttt{`r}.  A region is just a group of objects with the same
lifetime---all objects in a region are freed at once.  Cyclone uses
this region information to prevent dereferencing a pointer into a
previously freed region.  Regions can have a ``nested'' structure, for
example, if the region for a function parameter is a variable, then
the function may assume that the parameter points into a region whose
lifetime includes the lifetime of the function.
\end{faqa}

\begin{faqa}{faq:heapregion}{What does \texttt{`H} mean?}
  This is Cyclone's heap region: objects in this region cannot be
  explicitly freed, only garbage-collected.  Effectively, this means
  that pointers into the heap region can always be safely
  dereferenced; conceptually, objects in the heap last ``forever,''
  since they are always available if needed; garbage collection is
  like an optimization that frees objects after they are no longer
  needed.  
\end{faqa}

\begin{faqa}{faq:boundsregion}{What does \texttt{int @\lb 37\rb `r} mean?}
A pointer can come with all or none of the nullity, bound, and region
annotation.  This type is the type of non-\texttt{null} pointers to
at least 37 consecutive integers in region \texttt{`r}.  When the
bound is omitted it default to 1.
\end{faqa}

\begin{faqa}{faq:omitregion}{What is a pointer type's region when it's
omitted?} Every pointer type has a region; if you omit it, the
compiler puts it in for you implicitly.  The region added depends on
where the pointer type occurs.  In function arguments, a new region
variable is used.  In function results and type definitions (inlcuding
\texttt{typedef}), the heap region (\texttt{`H}) is used.  In function
bodies, the compiler looks at the uses (using unification) to try to
determine a region.
\end{faqa}

\begin{faqa}{faq:questionable}{What does \texttt{int ?} mean?}
The \texttt{?} a special kind of pointer that carries along bounds
information.  It is a ``questionable'' pointer: it might be NULL or
pointing out of bounds.  An \texttt{int ?} is a pointer to an integer,
along with some information that allows Cyclone to check whether the
pointer is in bounds at run-time.  These are the only kinds of
pointers that you can use for pointer arithmetic in Cyclone.
\end{faqa}

\begin{faqa}{faq:typevar}{What does \texttt{`a} mean?}
\texttt{`a} is a \emph{type variable}.  Type variables are typically
used in polymorphic functions.  For example, if a function takes a
parameter of type \texttt{`a}, then the function can be called with a
value of \emph{any} suitable type.  If there are two arguments of type
\texttt{`a}, then any call will have to give values of the same type
for those parameters.  And if the function returns a type \texttt{`a},
then it must return a result of the same type as the the argument.
Syntactically, a type variable is any identifier beginning with
\texttt{`} (backquote).
\end{faqa}

\begin{faqa}{faq:suitable}{What is a ``suitable'' type for a type variable?}
The last question said that a type variable can stand for a
``suitable'' type.  Unfortunately, not all types are ``suitable.''
Briefly, the ``suitable'' types are those that fit into a
general-purpose machine register, typically including \texttt{int},
pointers,
\texttt{tunion} types, and \texttt{xtunion} types.  Non-suitable types
include \texttt{float}, \texttt{struct} types (which can be of
arbitrary size), tuples, and questionable pointers.
Technically, the suitable types are the types of ``box kind,''
described below.
\end{faqa}

\begin{faqa}{faq:voidstar}{How do I cast from \texttt{void *}?}
You can't do this in Cyclone.  A \texttt{void *} in C really does not
point to \texttt{void}, it points to a value of some type.  However,
when you cast from a \texttt{void *} in C, there is no guarantee that
the pointer actually points to a value of the expected type.  This can
lead to crashes, so Cyclone doesn't permit it.  Cyclone's
polymorphism and tagged unions can often be used in places where C
needs to use \texttt{void *}, and they are safe.
\end{faqa}

\begin{faqa}{faq:uscore-types}{What does \texttt{_} (underscore) mean in types?}
Underscore is a ``wildcard'' type.  It stands for some type that the
programmer doesn't want to bother writing out; the compiler is
expected to fill in the type for the programmer.  Sometimes, the
compiler isn't smart enough to figure out the type (you will get an
error message if so), but usually there is enough contextual
information for the compiler to succeed.  For example, if you write
\begin{verbatim}
  _ x = new Pair(3,4);
\end{verbatim}
the compiler can easily infer that the wildcard stands for
\texttt{struct Pair @}.  In fact, if \texttt{x} is later assigned
\texttt{NULL}, the compiler will infer that \texttt{x} has type
\texttt{struct Pair *} instead.

Note that \texttt{_} is not allowed as part of top-level declarations.
\end{faqa}

% \begin{faqa}{faq:uscore-region}{In particular, what does \texttt{int *_} mean?}
% Here the wildcard ranges over the region of the pointer.  This use of
% the wildcard is important in making the region system easier to use.
% For example, in Cyclone you cannot write the following local declarations:
% \begin{verbatim}
%   int x;
%   int *y = &x;
% \end{verbatim}
% This is because local declarations live on the stack, and \texttt{int
%   *} is short for \texttt{int *`H}, the type of pointers to integers
% in the heap region.  Here \texttt{y} points to an integer on the
% stack, so the second declaration doesn't type check.  To get it to
% type check, you can put in the name of the local stack region, but it
% is simpler to use the wildcard:
% \begin{verbatim}
%   int *_ y = &x;
% \end{verbatim}
% Of course, you could have also used
% \begin{verbatim}
%   _ y = &x;
% \end{verbatim}
% or
% \begin{verbatim}
%   let y = &x;
% \end{verbatim}
% but you might want to write down the additional type information for
% documentation.
% \end{faqa}

\begin{faqa}{faq:kinds}{What do \texttt{`a::B}, \texttt{`a::M},
\texttt{`a::A}, \texttt{`a::R}, \texttt{`a::UR}, \texttt{`a::TR} and
\texttt{`a::E} mean?}  Types are divided into different groups, which we
call kinds.  There are four ``normal'' kinds: B (for Box), M (for Memory), A
(for Any), and E (for Effect); and three ``region'' kinds: R (for Region),
UR (for unique region), and TR (for either regular or unique region).  The
notation \texttt{typevar}\texttt{::}\textit{kind} says that a type variable
belongs to a kind.  A type variable can only be instantiated by types that
belong to its kind.

Box types include \texttt{int}, pointers (except for questionable pointers),
tagged unions, and extensible tagged unions.  Memory types include all box
types, tuples, \texttt{tunion} and \texttt{xtunion} variants, questionable
pointers, and non-abstract structs.  Any types include all types that don't
have kind R, UR, TR, or E.  For the region types, R indicates ``normal''
regions like the heap, stack, and dynamic regions; UR indicates the unique
region (i.e. only `U or an alias of it has kind UR); and TR indicates
either; UR and TR kinds are used generally only in certain
region-polymorphic functions; see Section~\ref{sec:poly-allocate}.  Effect
types are sets of regions (these are explained elsewhere).
\end{faqa}

\begin{faqa}{faq:nokinds}{What does it mean when type variables don't have explicit kinds?}
Every type variable has a kind, but usually the programmer doesn't
have to write it down.  In function prototypes, the compiler will
infer the most permissive kind.  For example,
\begin{verbatim}
  void f(`a *`b x, `c * y, `a z);
\end{verbatim}
is shorthand for
\begin{verbatim}
void f(`a::B *`b::R x, `c::M * y, `a::B z)
\end{verbatim}
In type definitions, no inference is performed: an omitted kind is
shorthand for \texttt{::B}.  For example,
\begin{verbatim}
struct S<`a,`r::R> { `a *`r x; };
\end{verbatim}
is shorthand for
\begin{verbatim}
struct S<`a::B,`r::R> { `a *`r x;};
\end{verbatim}
but
\begin{verbatim}
struct S<`a,`r>{`a *`r x;};
\end{verbatim}
is not.
\end{faqa}

\begin{faqa}{faq:list}{What does \texttt{struct List<`a,`r::R>} mean?}
\texttt{struct List} takes a type of box kind and a region and
produces a type.  For example, \texttt{struct List<int, `H>} is a
type, and \texttt{struct List<struct List<int,`H>@, `H>} is a type.
\texttt{struct List<`a,`r::R>} is a list whose elements all have type
\texttt{`a} and live in region \texttt{`r}.
\end{faqa}

\begin{faqa}{faq:tagged}{What are \texttt{tunion} and \texttt{xtunion}?}
These are Cyclone's tagged union and extensible tagged union types.
In C, when a value has \texttt{union} type, you know that in fact it
has one of the types of the union's fields, but there is no guarantee
which one.  This can lead to crashes in C\@.  Cyclone's tagged unions
are like C unions with some additional information that lets the
Cyclone compiler determine what type the underlying value actually
has, thus helping to ensure safety.
\end{faqa}

\begin{faqa}{faq:abstract}{What is \texttt{abstract}?}
\texttt{abstract} is a storage-class specifier, like \texttt{static}
or \texttt{extern}.  When attached to a top-level type declaration, it
means that other files can use the type but cannot look at the
internals of the type (e.g., other files cannot access the fields of
an abstract struct).  Otherwise, abstract has the same meaning as the
\texttt{auto} (default) storage class.  Hence \texttt{abstract} is a
way to state within a Cyclone file that a type's representation cannot
be exported.
\end{faqa}

\begin{faqa}{faq:keywords}{What are the Cyclone keywords?}
In addition to the C keywords, the following have special meaning and
cannot be used as identifiers: \texttt{abstract}, \texttt{catch},
\texttt{codegen}, \texttt{cut}, \texttt{fallthru}, \texttt{fill},
\texttt{let}, \texttt{malloc},
\texttt{namespace}, \texttt{new}, \texttt{NULL},
\texttt{region_t}, \texttt{regions},
\texttt{rmalloc}, \texttt{rnew}, \texttt{splice},
\texttt{throw}, \texttt{try}, \texttt{tunion}, \texttt{using},
\texttt{xtunion}.  As in gcc,
\texttt{__attribute__} is reserved as well.
\end{faqa}

\begin{faqa}{faq:namespace}{What are \texttt{namespace} and \texttt{using}?}
These constructs provide a convenient way to help avoid name clashes.
namespace X prepends X:: to the declarations in its body (rest of file
in case of namespace X;) and using X makes the identifiers prepended
with X:: available without having to write the X::.
\end{faqa}

\begin{faqa}{faq:fallthru}{What is \texttt{fallthru}?}
In Cyclone, you cannot implicitly fall through from one switch case to
the next (a common source of bugs in C).  Instead, you must explicitly
fall through with a \texttt{fallthru} statement.  So, to port C code,
place \texttt{fallthru;} at the end of each case that implicitly falls
through; note that \texttt{fallthru} may not appear in the last case
of a \texttt{switch}.

\texttt{fallthru} is useful for more than just catching bugs.  For
instance, it can appear anywhere in a case; its meaning is to
immediately goto the next case.  Second, when the next case of the
\texttt{switch} has pattern variables, a \texttt{fallthru} can (and
must) be used to specify expressions that will be bound to those
variables in the next case.  Hence \texttt{fallthru} is more powerful
(but more verbose) than ``or patterns'' in ML\@.
\end{faqa}

\begin{faqa}{faq:new}{What is \texttt{new}?}
\texttt{new} \textit{expr} allocates space in the heap region,
initializes it with the result of evaluating \texttt{expr}, and
returns a pointer to the space.  It is roughly equivalent to
\begin{alltt}
 \textit{type} @temp = malloc(sizeof(\textit{type}));
 *temp = \textit{expr};
\end{alltt}
where \texttt{type} is the type of \textit{expr}.  You can also write
\begin{alltt}
  new \lb for i < \textit{expr}\(\sb{1}\) : \textit{expr}\(\sb{2}\) \rb
\end{alltt}
to heap-allocate an array of size \textit{expr}$_1$ with the
\texttt{i}$^{\rm th}$ element initialized to \textit{expr}$_2$ (which
may mention \texttt{i}).
\end{faqa}

\begin{faqa}{faq:usetuples}{How do I use tuples?}
A tuple type is written
\texttt{\$(\textit{type}$_1$, \ldots, \textit{type}$_n$)}.
A value of the type is constructed by
\texttt{\$(\textit{expr}$_1$, \ldots, \textit{expr}$_n$)}.
where \textit{expr}$_i$ has type \textit{type}$_i$.  
If \textit{expr} has type
\texttt{\$(\textit{type}$_1$, \ldots, \textit{type}$_n$)},
you can extract the component \texttt{i} using
\textit{expr}\texttt{[i]}.
The expression in the brackets must be a compile-time constant.  In
short, tuples are like anonymous structs where you use
\textit{expr}\texttt{[i]} to extract fields instead of
\textit{expr}\texttt{.i}.
There is no analogue of the \texttt{->} syntax that can be used with
pointers of structs; if 
\textit{expr} has type
\texttt{\$(\textit{type}$_1$, \ldots, \textit{type}$_n$) *},
you can extract component \texttt{i} by \texttt{(*\textit{expr})[i]}.
\end{faqa}

\begin{faqa}{faq:arrayinit}{What is \texttt{\lb for i < {\it expr}$_1$ : {\it expr}$_2$\rb}?}
This is an array initializer.  It can appear where array
initializers appear in C, and it can appear as the argument to
\texttt{new}.
i
is an identifier.  e1 is an unsigned int indicating the size of the
array.  e2 is evaluated e1 times, with i having values 0, 1, ..., e1-1
and the result initializes the ith element of the array.  The form new
\texttt{\{for i < e1 : e2\}} allocates space for a new array and initializes it
as just described.  This form is the only way to create arrays whose
size depends on run-time information.  When \texttt{\{for i < e1:
e2\}} is not an argument to new, e1 must be constant and e2 may not
mention i.  This restriction includes all uses at top-level (for
global variables).
\end{faqa}

\begin{faqa}{faq:exns}{How do I throw and catch exceptions?}
A new exception is declared as in 
\begin{verbatim}
  xtunion exn { MyExn };
\end{verbatim}
The exception can be thrown with the statement
\begin{verbatim}
  throw MyExn;
\end{verbatim}
You can catch the expression with a \texttt{try}/\texttt{catch}
statement:
\begin{alltt}
  try {\it statement}\(\sb{1}\) catch \lb case MyExn: {\it statement}\(\sb{2}\) \rb
\end{alltt}
If {\it statement}$_1$ throws an \texttt{MyExn} and no inner
\texttt{catch} handles it, control transfers to 
{\it statement}$_2$.

The \texttt{catch} body can have any number of \texttt{case} clauses.
If none match, the exception is re-thrown.

Exceptions can carry values with them.  For example, here's how to
declare an exception that carries an integer:
\begin{verbatim}
  xtunion exn { MyIntExn(int) };
\end{verbatim}
Values of such exceptions must be heap-allocated.  For example, you
can create and throw a \texttt{MyIntExn} exception with
\begin{verbatim}
  throw new MyIntExn(42);
\end{verbatim}
To catch such an exception you must use an \texttt{\&}-pattern:
\begin{alltt}
  try {\it statement}\(\sb{1}\)
  catch \lb
    case &MyIntExn(x): {\it statement}\(\sb{2}\)
  \rb
\end{alltt}
When the exception is caught, the integer value is bound to \texttt{x}.

The \texttt{exn} type is just a pre-defined \texttt{xtunion} type.
Therefore, all the standard rules for extending, creating objects, and
destructing objects of an xtunion type apply.
\end{faqa}

\begin{faqa}{faq:exn-efficiency}{How efficient is exception handling?}
Entering a \texttt{try} block is implemented using \texttt{setjmp}.
Throwing an exception is implemented with \texttt{longjmp}.
Pattern-matching an
\texttt{xtunion} against each case variant in the catch clause is a
pointer-comparsion.  In short, exception handling is fairly
lightweight.
\end{faqa}

\begin{faqa}{faq:let}{What does \texttt{let} mean?}
In Cyclone, \texttt{let} is used to declare variables.  For example,
\begin{verbatim}
  let x,y,z;
\end{verbatim}
declares the three variables \texttt{x}, \texttt{y}, and \texttt{z}.
The types of the variables do not need to be filled in by the
programmer, they are filled in by the compiler's type inference
algorithm.  The \texttt{let} declaration above is equivalent to
\begin{verbatim}
  _ x;
  _ y;
  _ z;
\end{verbatim}

There is a second kind of \texttt{let} declaration, with form
\begin{alltt}
  let {\it pattern} = {\it expr};
\end{alltt}
It evaluates \textit{expr} and matches it against \texttt{pattern},
initializing the pattern variables of \textit{pattern} with values
drawn from \texttt{expr}.  For example,
\begin{verbatim}
  let x = 3;
\end{verbatim}
declares a new variable \texttt{x} and initializes it to 3, and
\begin{verbatim}
  let $(y,z) = $(3,4);
\end{verbatim}
declares new variables \texttt{y} and \texttt{z}, and initializes
\texttt{y} to 3 and \texttt{z} to 4.
\end{faqa}

\begin{faqa}{faq:pattern}{What is a pattern and how do I use it?}
Cyclone's patterns are a convenient way to destructure aggregate
objects, such as structs and tuples.  They are also the only way to
destructure tagged unions.  Patterns are used in Cyclone's
\texttt{let} declarations, \texttt{switch} statements, and
\texttt{try}/\texttt{catch} statements.
\end{faqa}

\begin{faqa}{faq:uscore-pattern}{What does \texttt{_} mean in a pattern?}
It is a wildcard pattern, matching any value.  For example, if
\texttt{f} is a function that returns a pair, then
\begin{verbatim}
  let $(_,y) = f(5); 
\end{verbatim} %$ <-- this dollar comment fixes up font highlighting
is a way to extract the second element of the pair and bind it to a
new variable \texttt{y}.
\end{faqa}

\begin{faqa}{faq:polymorphic}{What does it mean when a function has an argument with type \texttt{`a}?}
Any type that looks like \texttt{`} (backquote) followed (without
whitespace) by an identifier is a type variable.  If a function
parameter has a type variable for its type, it means the function can
be called with any pointer or with an int.  However, if two parameters
have the same type variable, they must be instantiated with the same
type. If all occurrences of `a appear directly under pointers (eg. `a
*), then an actual parameter can have any type, but the restrictions
about using the same type still apply.  In general, Cyclone has
parametric polymorphism as a safe alternative to casts and void *.
\end{faqa}

\begin{faqa}{faq:templates}{Do functions with type variables get duplicated like C++ template functions?\\  Is there run-time overhead for using type variables?}
No and no.  Each Cyclone function gives rise to one function in the
output, and types are not present at run-time.  When a function is
called, it does not need to know the types with which the caller is
instantiating the type variables, so no instantiation actually
occurs---the types are not present at run-time.  We do not have to
duplicate the code because we either know the size of the type or the
size does not matter.  This is why we don't allow type variables of
memory kind as parameters---doing so would require code duplication or
run-time types.
\end{faqa}

\begin{faqa}{faq:vararg}{Can I use varargs?}
Yes, Cyclone has a way of supporting variable-argument functions.  It
is not quite the same as C's, but it is safe.  For instance, we have
written type-safe versions of printf and scanf all within Cyclone.
See the documentation on varargs for more information.
\end{faqa}

\begin{faqa}{faq:typesinfunctions}{Why can't I declare types within functions?}
We just haven't implemented this support yet.  For now, you need to
hoist type declarations and typedefs to the top-level.
\end{faqa}

\begin{faqa}{faq:casts}{What casts are allowed?}
Cyclone doesn't support all of the casts that C does, because
incorrect casts can lead to crashes.  Instead, Cyclone supports a safe
subset of C's casts.  Here are some examples.

All of C's numeric casts, conversions, and promotions are unchanged.

You can always cast between
\textit{type}\texttt{@}\lb\textit{const}\rb,
\textit{type}\texttt{*}\lb\textit{const}\rb, and
\textit{type}\texttt{?}.
A cast from 
\textit{type}\texttt{?}
to one of the other types includes a run-time check that the pointer
points to a sequence of at least \textit{const} objects.
A cast to
\textit{type}\texttt{@}\lb\textit{const}\rb
from one of the
other types includes a run-time check that the pointer is not
\texttt{NULL}.
No other casts between these type have run-time checks.
A failed run-time check throws \texttt{Null_Exception}.
A pointer into the heap can be cast to a pointer into another region.
A pointer to a \texttt{struct} or \texttt{tuple} can be
cast to a pointer to another \texttt{struct} or \texttt{tuple}
provided the ``target type'' 
is \emph{narrower} (it has fewer fields after ``flattening out'' nested
\texttt{structs} and \texttt{tuples}) and each (flattened out) field
of the target type could be the target of a cast from the
corresponding field of the source type.
A pointer can be cast to \texttt{int}.
The type
\textit{type}\texttt{*}\lb\textit{const}$_1$\rb
can be cast to
\textit{type}\texttt{*}\lb\textit{const}$_2$\rb
provided
$\textit{const}_2 < \textit{const}_1$, and similarly for
\textit{type}\texttt{@}\lb\textit{const}$_1$\rb
and
\textit{type}\texttt{@}\lb\textit{const}$_2$\rb.

An object of type \texttt{tunion T.A} can be cast to \texttt{tunion T}
if \texttt{A} does not carry values.  An object of type tunion
\texttt{T.A@} can be cast to \texttt{tunion T} if \texttt{A} does
carry values.  The current implementation isn't quite as lenient as it
should be.  For example, it rejects a cast from \texttt{int *\lb 4\rb} to
\texttt{\$(int,int)*\lb 2\rb}, but this cast is safe.

For all non-pointer-containing types \textit{type}, you can cast from a
\textit{type ?} to a \texttt{char} \textit{?}.  This allows you to make
frequent use of \texttt{memcpy}, \texttt{memset}, \emph{etc.}
\end{faqa}

\begin{faqa}{faq:implicitfallthru}{Why can't I implicitly fall-through to the next \texttt{switch} case?}
We wanted to add an explicit \texttt{fallthru} construct in
conjunction with pattern matching, and we decided to enforce use of
\texttt{fallthru} in all cases because this is a constant source of
bugs in C code.
\end{faqa}

\begin{faqa}{faq:globalinit}{Do I have to initialize global variables?}
You currently must provide explicit initializers for global variables that
may contain pointers, so that the compiler can be sure that uninitialized
memory containing pointers is not read.  In the future, we expect to provide
some support for initializing globals in constructor functions.  

Two techniques help with initializing global arrays.  First, if an array
element could be 0 or NULL, the compiler will insert 0 for any elements you
do not specify.  For example, you can write
\begin{verbatim}
  int x[37] = {};
\end{verbatim}
to declare a global array \texttt{x} initialized with 37 elements, all 0.
Second, you can use
the comprehension form
\begin{alltt}
  int x[37] = \lb for i < \textit{expr}\(\sb{1}\) : \texttt{expr}\(\sb{2}\) \rb
\end{alltt}
provided that 
\textit{expr}$_1$ and
\textit{expr}$_2$ and
constant expressions.
Currently, \textit{expr}$_2$ may not use the variable \texttt{i}, but
in the future it will be able to.  Note that it is not possible to
have a global variable of an abstract type because it is impossible to
know any constant expression of that type.
\end{faqa}

\begin{faqa}{faq:threads}{Are there threads?}
Cyclone does not yet have a threads library and some of the libraries
are not re-entrant.  In addition, because Cyclone uses unboxed structs
of three words
to represent fat pointers, and updating them is not an atomic operation,
it's possible to introduce unsoundnesses by adding concurrent threads.
However, in the future, we plan to provide support for threads and
a static analysis for preventing these and other forms of data races.
\end{faqa}

\begin{faqa}{faq:setjmp}{Can I use \texttt{setjmp} and \texttt{longjmp}?}
No.  However, Cyclone has exceptions, which can be used for non-local
control flow.  The problem with \texttt{setjmp} and \texttt{longjmp}
is that safety demands we prohibit a \texttt{longjmp} to a place no
longer on the stack.  A future release may have more support for
non-local control flow.
\end{faqa}

\begin{faqa}{faq:uniontypes}{What types are allowed for union members?}
Currently, \texttt{union} members cannot contain pointers.  You can
have numeric types (including bit fields and enumerations), structs
and tuples of allowable union-member types, and other unions.
\end{faqa}

\begin{faqa}{faq:voidstar2}{Why can't I do anything with values of type \texttt{void *}?}
Because we cannot know the size of an object pointed to by a pointer
of type void *, we prohibit derefencing the pointer or casting it to a
different pointer type.  To write code that works for all pointer
types, use type variables and polymorphism.  Tagged unions can also
substitute in some cases where \texttt{void *} is used in C\@.
\end{faqa}

\begin{faqa}{faq:aprintf}{What is \texttt{aprintf}?}
The \texttt{aprintf} function is just like \texttt{printf}, but
the output is placed in a new string allocated on the heap.
\end{faqa}

\begin{faqa}{faq:commandline}{How do I access command-line arguments?}
The type of \texttt{main} should be
\begin{verbatim}
  int main(int argc, char ?? argv);
\end{verbatim}
As in C, \texttt{argc} is the number of command-line arguments and
\texttt{argv[i]} is a string with the \texttt{i}$^{\rm th}$ argument.
Unlike C, \texttt{argv} and each element of \texttt{argv} carry bounds
information.  Note that \texttt{argc} is redundant---it is always
equal to \texttt{argv.size}.
\end{faqa}

\begin{faqa}{faq:stackpointer}{Why can't I pass a stack pointer to certain functions?}
If the type of a function parameter is a pointer into the heap region,
it cannot be passed a stack parameter.  Pointer types in typedef and
struct definitions refer to the heap region unless there is an
explicit region annotation.
\end{faqa}

\begin{faqa}{faq:localaddress}{Why do I get an incomprehensible error when I assign a local's address to a pointer variable?}
If the pointer variable has a type indicating that it points into the
heap, then the assignment is illegal.  Try initializng the pointer variable
with the local's address, rather than delaying the assignment until later.
\end{faqa}

\begin{faqa}{faq:pointerarith}{How much pointer arithmetic can I do?}
On ``questionable'' pointers (pointers with type
\textit{type}\texttt{?}), you can add or subtract an int (including
via increment/decrement), as in C\@.  It is okay for the result to be
outside the bounds of the object pointed to; it is a run-time error to
dereference outside of the bounds.  (The compiler inserts bounds
information and a run-time check; an exception is thrown if the check
fails.)  Currently, we do not support pointer arithmetic on the other
pointer types.  As in C, you can subtract two pointers of the same
type; the type of the result is \texttt{unsigned int}.
\end{faqa}

\begin{faqa}{faq:litstring}{What is the type of a literal string?}
The type of the string constant \texttt{"foo"} is \texttt{char @\lb
  4\rb} (remember the trailing null character).  However, there are implicit
casts from \texttt{char @\lb 4\rb} to \texttt{char @\lb 2\rb},
\texttt{char *\lb 4\rb}, and \texttt{char ?}, so you shouldn't have to
think too much about this.
\end{faqa}

\begin{faqa}{faq:nullterminate}{Are strings null-terminated?}
Cyclone follows C's lead on this.  String literals like \texttt{"foo"}
are null-terminated.  Many of the library functions consider a null
character to mark the end of a string.  And library functions that
return strings often ensure that they are null terminated.  However,
there is no guarantee that a string is null terminated.  For one
thing, as in C, the terminating null may be overwritten by any
character.  In C this can be exploited to cause buffer overflows.  To
avoid this in Cyclone, strings generally have type \texttt{char ?},
that is, they carry bounds information.  In Cyclone a string ends when
a null character is found, or when the bounds are exceeded.
\end{faqa}

\begin{faqa}{faq:malloc}{How do I use \texttt{malloc}?}
\texttt{malloc} is a Cyclone primitive, not a library function.
Currently it has an extremely restricted syntax: You must write
\texttt{malloc(sizeof(\textit{type}))}.  The result has type
\textit{type}\texttt{@}, so usually there is no need to explicitly
cast the result (but doing so is harmless).  Usually the construct
\texttt{new} \textit{expr} is more convenient than malloc followed by
initialization, but \texttt{malloc} can be useful for certain idioms
and when porting C code.

Notice that you cannot (yet) use \texttt{malloc} to allocate space for
arrays (as in the common idiom, \texttt{malloc(n*sizeof({\it type}))}.
Also, the type-checker uses a conservative analysis to ensure that the
fields of the allocated space are written before they are used.
\end{faqa}

\begin{faqa}{faq:free}{Can I call free?}
Yes and no. Individual memory objects may not be freed.  In future versions,
we may support freeing objects for which you can prove that there are no
other pointers to the object.  Until then, you must rely on a garbage
collector to reclaim heap objects or use regions (similar to ``arenas'' or
``zones'') for managing collections of objects.

For porting code, we have defined a \texttt{free} function that behaves as a
no-op, having type
\begin{verbatim}
  void free(`a::A ?);
\end{verbatim}
\end{faqa}

\begin{faqa}{faq:gc}{Is there a garbage collector?}
Yes, we use the Boehm-Demers-Weiser conservative collector.  If you
don't want to use the garbage collector (e.g., because you know that
your program does little or no heap allocation), you can use the
\texttt{-nogc} flag when linking your executable.  This will make the
executable smaller.

If you link against additional C code, that code must obey the usual
rules for conservative garbage collection: no wild pointers and no
calling \texttt{malloc} behind the collector's back.  Instead, you
should call \texttt{GC_malloc}.  See the collector's documentation for
more information.

Note that if you allocate all objects on the stack, garbage collection
will never occur.  If you allocate all objects on the stack or in
regions, it is very unlikely collection will occur and nothing will
actually get collected.
\end{faqa}

\begin{faqa}{faq:stackalloc}{How can I make a stack-allocated array?}
As in C, you declare a local variable with an array type.  Also as in
C, all uses of the variable, except as an argument to \texttt{sizeof}
and \texttt{\&}, are promoted to a pointer.  If your declaration is
\begin{verbatim}
int x[256];
\end{verbatim}
then uses of \texttt{x} have type \texttt{int @`L\lb 256\rb} where
\texttt{L} is the name of the block in which \texttt{x} is declared.
(Most blocks are unnamed and the compiler just makes up a name.)

Stack-allocated arrays must be initialized when they are declared
(unlike other local variables).  Use an array-initializer, as in
\begin{verbatim}
  int y[] = { 0, 1, 2, 3 };
  int z[] = { for i < 256 : i };
\end{verbatim}

To pass (a pointer to) the array to another function, the function
must have a type indicating it can accept stack pointers, as explained
elsewhere.
\end{faqa}

\begin{faqa}{faq:realloc}{Can I use \texttt{salloc} or \texttt{realloc}?}
Currently, we don't provide support for \texttt{salloc}.  For 
\texttt{realloc}, we do provide support, but only on heap-allocated
\texttt{char?} buffers.
\end{faqa}

\begin{faqa}{faq:nullcast}{Why do I have to cast from \texttt{*} to \texttt{@} if I've already tested for \texttt{NULL}?} 
Our compiler is not as smart as you are.  It does not realize that you
have tested for \texttt{NULL}, and it insists on a check (the cast)
just to be sure.  You can leave the cast implicit, but the compiler
will emit a warning.  We are currently working to incorporate a flow
analysis to omit spurious warning.  Because of aliasing, threads, and 
undefined evaluation order, a sound analysis is non-trivial.
\end{faqa}

\begin{faqa}{faq:memkind}{Why can't a function parameter or struct field have type \texttt{`a::M}?} 
Type variables of memory kind can be instantiated with types of any
size.  There is no straightforward way to compile a function with an
argument of arbitrary size.  The obvious way to write such a function
is to manipulate a pointer to the arbitrary size value instead.  So
your parameter should have type \texttt{`a::M*} or \texttt{`a::M@}.
\end{faqa}

\begin{faqa}{faq:compile}{Can I see how Cyclone compiles the code?}
The easiest way to do this is to pass the flags \texttt{-save-c} and
\texttt{-pp} to the compiler.  This instructs the compiler to save the
C code that it builds and passes to GCC, and print it out using the
pretty-printer.  You will have to work to make some sense out of the C
code, though.  It will likely contain many \texttt{extern}
declarations (because the code has already gone through the
preprocessor) and generated type definitions (because of tuples,
tagged unions, and questionable pointers).  Pattern-matching code gets
translated to a mess of temporary variables and \texttt{goto}
statements.  Array-bounds checks and \texttt{NULL} checks can clutter
array-intensive and pointer-intensive code.  And all \texttt{typedef}s
are expanded away before printing the output.
\end{faqa}

\begin{faqa}{faq:gdb}{Can I use \texttt{gdb} on the output?}
You can run {\tt gdb}, but debugging support is not all the way there yet.
By default, source-level debugging operations within {\tt gdb} will
reference the C code generated by the Cyclone compiler, not the Cyclone
source itself.  In this case, you need to be aware of three things.  First,
you have to know how Cyclone translates top-level identifiers to C
identifiers (it prepends Cyc_ and separates namespaces by _ instead of ::)
so you can set breakpoints at functions.  Second, it can be hard to print
values because many Cyclone types get translated to \texttt{void *.}  Third,
we do not yet have source correlation, so if you step through code, you're
stepping through C code, not Cyclone code.

To improve this situation somehwat, you can compile your files with the
option \texttt{--lineno}.  This will insert \texttt{\#line} directives in the
generated C code that refer to the original Cyclone code.  This will allow
you to step through the program and view the Cyclone source rather than the
generated C.  However, doing this has two drawbacks.  First, it may occlude
some operation in the generated C code that is causing your bug.  Second,
compilation with \texttt{--lineno} is significantly slower than without.
Finally, the result is not bug-free; sometimes the debugger will fall behind
the actual program point and print the wrong source lines; we hope to fix
this problem soon.

Two more hints: First, on some architectures, the first memory
allocation appears to seg fault in \texttt{GC_findlimit}.  This is
correct and documented garbage-collector behavior (it handles the
signal but \texttt{gdb} doesn't know that); simply continue execution.
Second, a common use of \texttt{gdb} is to find the location of an
uncaught exception.  To do this, set a breakpoint at \texttt{throw} (a
function in the Cyclone runtime).
\end{faqa}

\begin{faqa}{faq:gprof}{Can I use \texttt{gprof} on the output?}
Yes, just use the \texttt{-pg} flag.  You should also rebuild the
Cyclone libraries and the garbage collector with the \texttt{-pg}
flag.  The results of \texttt{gprof} make sense because a Cyclone
function is compiled to a C function.

Notes for Cygwin users: First, the versions of \texttt{libgmon.a} we
have downloaded from cygnus are wrong (every call gets counted as a
self-call).  We have modified libgmon.a to fix this bug, so download
our version and put it in your cygwin/lib directory.  Second, timing
information should be ignored because \texttt{gprof} is only sampling
100 or 1000 times a second (because it is launching threads instead of
using native Windows profiling).  Neither of these problems are
Cyclone-specific.
\end{faqa}

\begin{faqa}{faq:emacs}{Is there an Emacs mode for Cyclone?}
Sort of.  In the \texttt{doc/} directory of the distribution you will
find a \texttt{font-lock.el} file and elisp code (in
\texttt{cyclone_dot_emacs.el}) suitable for inclusion in your
\texttt{.emacs} file.  However, these files change C++ mode and use it
for Cyclone rather than creating a new Cyclone mode.  Of course, we
intend to make our own mode rather than destroy C++-mode's ability to
be good for C++.  Note that we have not changed the C++ indentation
rules at all; our elisp code is useful only for syntax highlighting.
\end{faqa}

\begin{faqa}{faq:rtcg}{Does Cyclone have something to do with runtime code generation?}
Cyclone has its roots in Popcorn, a language which was safe but not as
compatible with C\@.  An offshoot of Popcorn added safe runtime code
generation, and was called Cyclone.  The current Cyclone language is a
merger of the two, refocused on safety and C compatibility.
Currently, the language does not have support for runtime code
generation, but we have reserved the keywords \texttt{codegen},
\texttt{splice}, \texttt{cut}, and \texttt{fill} in case we get a
chance to add it.
\end{faqa}

\begin{faqa}{faq:platforms}{What platforms are supported?}
You need a platform that has gcc 2.9, GNU make, ar, sed, either bash or ksh,
and the ability to build the Boehm-Demers-Weiser garbage collector.
Furthermore, the size of \texttt{int} and all C pointers must be the same.
We have actively develop Cyclone on cygwin (Windows 98, NT, 2K), and Linux.
We have code for versions on Solaris, OpenBSD, FreeBSD, and Mac OS X.  The
platform-specific parts of these non-development distributions, particularly
system call interfaces, may not be correct.  We are in the process of
developing a tool to automatically generate system-dependent code that
should be part of future releases.
\end{faqa}

\begin{faqa}{faq:libs}{Why aren't there more libraries?}
We are eager to have a wider code base, but we are compiler writers
with limited resources.  Let us know of useful code you write.
\end{faqa}

\begin{faqa}{faq:imprev}{Why doesn't \texttt{List::imp_rev(l)} change \texttt{l} to its reverse?} 
The library function \texttt{List::imp_rev} mutates its argument by
reversing the \texttt{tl} fields.  It returns a pointer to the new
first (old last) cell, but \texttt{l} still points to the old first
(new last) cell.
\end{faqa}

\begin{faqa}{faq:inline}{Can I inline functions?}
Functions can be declared inline as in ISO C99.  You can get additional
inlining by compiling the Cyclone output with the \texttt{-O2} flag.
Whether a function is inlined or not has no effect on Cyclone
type-checking.
\end{faqa}

\begin{faqa}{faq:crash}{If Cyclone is safe, why does my program crash?}
There are certain classes of errors that Cyclone does not attempt to
prevent.  Two examples are stack overflow and various numeric traps,
such as division-by-zero.  It is also possible to run out of memory.
Other crashes could be due to compiler bugs or linking against buggy C
code (or linking incorrectly against C code).

Note that when using \texttt{gdb}, it may appear there is a seg fault
in GC_findlimit().  This behavior is correct; simply continue
execution.
\end{faqa}

\begin{faqa}{faq:ctc}{What are compile-time constants?}
Compile-time constants are \texttt{NULL}, integer and character
constants, and arithmetic operations over compile-time constants.
Constructs requiring compile-time constants are: tuple-subscript
(e.g.,
\texttt{x[3]} for tuple \texttt{x}), case argument for 
\texttt{switch "C"} argument has a numeric type (e.g., \texttt{case
  3+4}:), sizes in array declarations (e.g., \texttt{int y[37]}, and
sizes in pointer bounds (e.g., \texttt{int * x\lb 124\rb}).  Unlike in
C, \texttt{sizeof(t)} is not an integral constant expression because
the Cyclone compiler does not know the actual size of aggregate types.
\end{faqa}

\begin{faqa}{faq:arraysize}{How can I get the size of an array?}
If \textit{expr} is an array, then \texttt{{\it expr}.size} returns
the array's size.  Note that for \texttt{?} types, the size is
retrieved at runtime from the object.  For other array types,
the size is determined at compile-time.
\end{faqa}

% Local Variables:
% TeX-master: "main-screen"
% End:
